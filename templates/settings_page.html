{% extends 'base.html' %}

{% block title %}Settings - Arcade Manager{% endblock %}

{% block content %}
    <div class="content-header">
        <div class="content-header-left">
            <h2>App Settings</h2>
            <p>Manage application preferences and reset options here.</p>
        </div>
    </div>

    <section class="section-card collapsible-section">
        <div class="collapsible-header" id="resetOptionsToggle">
            <h3>Reset Options</h3>
            <i class="fas fa-chevron-down toggle-icon"></i>
        </div>
        <div class="collapsible-content">
            <div class="collapsible-section nested-section">
                <div class="collapsible-header" id="mainDashboardResetToggle">
                    <h4>Main Dashboard</h4>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </div>
                <div class="collapsible-content">
                    <button id="resetOpeningChecklistBtn" class="reset-button">
                        <i class="fas fa-undo"></i> Reset Opening Checklist Status
                    </button>
                    <p class="reset-description">This will un-gray the "Start Opening Checklist" card on the Dashboard.</p>
                    <button id="resetIssueHubTableBtn" class="reset-button reset-red-button">
                            <i class="fas fa-trash"></i> Reset Issue Hub Table
                        </button>
                        <p class="reset-description">This will permanently **delete all issues** from the system.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="section-card" style="margin-top: 2rem;">
        <h3>General Settings</h3>
        <p>This section will contain other application-wide settings.</p>
    </section>
        <section class="section-card" id="employeesCard" style="margin-top: 2rem;">
        <h3>Employees</h3>
        <p>Add or remove people for the “Assigned Employee” dropdown.</p>

        <div class="row" style="display:flex; gap:8px; align-items:center; margin-top:10px;">
            <input id="empNameInput" placeholder="Add name…" style="flex:1; padding:8px;">
            <button id="empAddBtn" type="button">Add</button>
        </div>

        <div id="empMsg" class="muted" style="margin-top:6px; opacity:.8;"></div>

        <ul id="empList" class="emp-list" style="list-style:none; padding:0; margin-top:10px;"></ul>
        </section>
    <hr>
    <section class="section-card system-status-card" style="margin-top: 2rem;">
        <h3>System Status</h3>
        <p>Real-time status of critical application services.</p>
        <div class="status-list">
            <div class="status-item">
                <span id="database-dot" class="status-dot unknown"></span>
                <span class="status-label">Database:</span>
                <span id="database-message" class="status-message">Checking...</span>
            </div>
            <div class="status-item">
                <span id="storage-dot" class="status-dot unknown"></span>
                <span class="status-label">Storage:</span>
                <span id="storage-message" class="status-message">Checking...</span>
            </div>
            <div class="status-item">
                <span id="issue-api-dot" class="status-dot unknown"></span>
                <span class="status-label">Issue API:</span>
                <span id="issue-api-message" class="status-message">Checking...</span>
            </div>
        </div>
        <div class="button-row">
            <button id="refreshStatusBtn" class="refresh-button">Refresh Status</button>
        </div>
    </section>
    
    <style>
        .collapsible-section {
            margin-bottom: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: #f8fafc;
            cursor: pointer;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.2s ease-in-out;
        }

        .collapsible-header:hover {
            background-color: #f0f4f8;
        }

        .collapsible-header h3, .collapsible-header h4 {
            margin: 0;
            font-size: 1.25rem;
            color: #1f2937;
        }

        .collapsible-header .toggle-icon {
            transition: transform 0.3s ease-in-out;
        }

        .collapsible-header.active .toggle-icon {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
            padding: 0 1.5rem;
        }

        .collapsible-content.active {
            max-height: 500px;
            padding: 1.5rem;
        }

        .nested-section .collapsible-header {
            background-color: #ffffff;
            border-bottom: none;
            padding: 0.75rem 1rem;
        }

        .nested-section .collapsible-header h4 {
            font-size: 1.1rem;
        }

        .nested-section .collapsible-content {
            padding: 0 1rem;
        }

        .nested-section .collapsible-content.active {
            padding: 1rem;
        }

        .reset-button {
            background-color: #dc3545;
            color: white;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .reset-button:hover {
            background-color: #c82333;
            transform: translateY(-1px);
        }

        .reset-button:active {
            transform: translateY(0);
        }

        .reset-description {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }
        
        /* New styles for the System Status card */
        .system-status-card {
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .status-list {
            margin-top: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .status-dot.ok {
            background-color: #4CAF50;
        }

        .status-dot.error {
            background-color: #F44336;
        }

        .status-dot.unknown {
            background-color: #9E9E9E;
        }

        .status-label {
            font-weight: 600;
            color: #1f2937;
            margin-right: 5px;
        }

        .status-message {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .refresh-button {
            background-color: #1a73e8;
            color: white;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            margin-top: 1rem;
            float: right;
        }
        
        .refresh-button:hover {
            background-color: #1764c9;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Logic for collapsible sections
            function setupCollapsible(headerId, contentClass) {
                const header = document.getElementById(headerId);
                if (header) {
                    const content = header.nextElementSibling; 
                    if (content && content.classList.contains(contentClass)) {
                        header.addEventListener('click', () => {
                            header.classList.toggle('active');
                            content.classList.toggle('active');
                        });
                    }
                }
            }
            setupCollapsible('resetOptionsToggle', 'collapsible-content');
            setupCollapsible('mainDashboardResetToggle', 'collapsible-content');

            // Logic for system status
            const databaseDot = document.getElementById('database-dot');
            const databaseMessage = document.getElementById('database-message');
            const storageDot = document.getElementById('storage-dot');
            const storageMessage = document.getElementById('storage-message');
            const issueApiDot = document.getElementById('issue-api-dot');
            const issueApiMessage = document.getElementById('issue-api-message');
            const refreshStatusBtn = document.getElementById('refreshStatusBtn');

            function updateStatusUI(dotElement, messageElement, status, message) {
                dotElement.classList.remove('ok', 'error', 'unknown');
                dotElement.classList.add(status);
                messageElement.textContent = message;
            }

            async function fetchSystemStatus() {
                updateStatusUI(databaseDot, databaseMessage, 'unknown', 'Checking...');
                updateStatusUI(storageDot, storageMessage, 'unknown', 'Checking...');
                updateStatusUI(issueApiDot, issueApiMessage, 'unknown', 'Checking...');

                try {
                    const response = await fetch('/api/health');
                    const data = await response.json();

                    if (data.services.database) {
                        updateStatusUI(databaseDot, databaseMessage, data.services.database.status, data.services.database.message);
                    }
                    if (data.services.storage) {
                        updateStatusUI(storageDot, storageMessage, data.services.storage.status, data.services.storage.message);
                    }
                    if (data.services.issue_api) {
                        updateStatusUI(issueApiDot, issueApiMessage, data.services.issue_api.status, data.services.issue_api.message);
                    }
                } catch (error) {
                    console.error('Error fetching system status:', error);
                    updateStatusUI(databaseDot, databaseMessage, 'error', 'Failed to connect to health API.');
                    updateStatusUI(storageDot, storageMessage, 'error', 'Failed to connect to health API.');
                    updateStatusUI(issueApiDot, issueApiMessage, 'error', 'Failed to connect to health API.');
                }
            }

            refreshStatusBtn.addEventListener('click', fetchSystemStatus);
            fetchSystemStatus();
        });
        // ===== Employees Manager =====
        const empNameInput = document.getElementById('empNameInput');
        const empAddBtn    = document.getElementById('empAddBtn');
        const empList      = document.getElementById('empList');
        const empMsg       = document.getElementById('empMsg');

        function setEmpMsg(text, isError=false){
            if (!empMsg) return;
            empMsg.textContent = text || '';
            empMsg.style.color = isError ? '#d32f2f' : '#6c757d';
        }

        function escapeHtml(s){
            return String(s||'')
            .replaceAll('&','&amp;')
            .replaceAll('<','&lt;')
            .replaceAll('>','&gt;')
            .replaceAll('"','&quot;')
            .replaceAll("'",'&#39;');
        }

        async function loadEmployees(){
            if (!empList) return;
            try{
            const res = await fetch('/api/employees');
            const data = await res.json();
            const items = Array.isArray(data.items) ? data.items : [];
            empList.innerHTML = '';
            if (!items.length){
                setEmpMsg('No employees yet. Add some!');
                return;
            }
            setEmpMsg('');
            for (const e of items){
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                li.style.padding = '8px 0';
                li.dataset.id = e.id;

                const nameSpan = document.createElement('span');
                nameSpan.textContent = e.name;
                nameSpan.style.fontWeight = '500';

                const delBtn = document.createElement('button');
                delBtn.textContent = 'Remove';
                delBtn.className = 'emp-remove';
                delBtn.style.border = '0';
                delBtn.style.borderRadius = '6px';
                delBtn.style.background = '#ef4444';
                delBtn.style.color = '#fff';
                delBtn.style.padding = '6px 10px';
                delBtn.style.cursor = 'pointer';

                li.appendChild(nameSpan);
                li.appendChild(delBtn);
                empList.appendChild(li);
            }
            }catch(err){
            console.error(err);
            setEmpMsg('Could not load employees.', true);
            }
        }

        empAddBtn?.addEventListener('click', async () => {
            const name = (empNameInput?.value || '').trim();
            if (!name){
            setEmpMsg('Type a name first.', true);
            return;
            }
            try{
            const res = await fetch('/api/employees', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({name})
            });
            const data = await res.json();
            if (!res.ok){
                const msg = data?.error?.includes('UNIQUE') ? 'Name already exists.' : (data?.error || 'Add failed.');
                setEmpMsg(msg, true);
                return;
            }
            empNameInput.value = '';
            setEmpMsg(`Added ${name}.`);
            localStorage.setItem('employees.updated', Date.now().toString());
            try { const bc = new BroadcastChannel('employees'); bc.postMessage('updated'); bc.close(); } catch {}

            loadEmployees();
            }catch(err){
            console.error(err);
            setEmpMsg('Network error adding employee.', true);
            }
        });

        empList?.addEventListener('click', async (e) => {
            const btn = e.target.closest('.emp-remove');
            if (!btn) return;
            const li = btn.closest('li');
            const id = li?.dataset.id;
            if (!id) return;
            try{
            const res = await fetch(`/api/employees/${id}`, { method:'DELETE' });
            const data = await res.json().catch(()=>({}));
            if (!res.ok){
                setEmpMsg(data?.error || 'Delete failed.', true);
                return;
            }
            setEmpMsg('Removed.');
            localStorage.setItem('employees.updated', Date.now().toString());
            try { const bc = new BroadcastChannel('employees'); bc.postMessage('updated'); bc.close(); } catch {}

            loadEmployees();
            }catch(err){
            console.error(err);
            setEmpMsg('Network error removing employee.', true);
            }
        });

        // kick it off on page load (only if the Employees card exists)
        if (document.getElementById('employeesCard')){
            loadEmployees();
        }
    </script>
    <script type="module" src="{{ url_for('static', filename='js/modules/settings_status.js') }}"></script>

{% endblock content %}