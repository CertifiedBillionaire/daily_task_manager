{% extends 'base.html' %}

{% block title %}Arcade Manager Dashboard{% endblock %}

{% block content %}
  <div class="content-header">
    <div class="dashboard-overview-header">
      <div class="content-header-left">
        <h2>Arcade Operations Overview</h2>
      </div>
    </div>
  </div>
  <style>
    /* === Simple Modal: iPad-friendly sizing & header layout === */
    .simple-modal__panel {
      width: min(92vw, 900px);
      max-width: 900px;
    }
    @media (min-width: 768px) {
      .simple-modal__panel { width: min(90vw, 960px); max-width: 960px; }
    }
    .simple-modal__header { display: flex; align-items: center; gap: 12px; }
    .simple-modal__header h3 { margin: 0; }
    .simple-modal__close { margin-left: auto; }

    /* === Add Issue modal form enhancements === */
    .ai-form .ai-row { margin-bottom: 12px; }
    .ai-form .ai-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 12px; }
    @media (min-width: 640px) { .ai-form .ai-grid { grid-template-columns: 1fr 1fr; } }
    .ai-form label { font-weight: 600; display:block; margin-bottom: 6px; }
    .ai-form textarea { width: 100%; resize: vertical; }

    .ai-actions { display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-top: 8px; }
    .ai-btn { padding: 12px 18px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; }
    .ai-btn-primary { font-size: 1rem; }
    .ai-link-btn { display: inline-block; padding: 10px 14px; border-radius: 8px; text-decoration: none; border: 1px solid #c9c9c9; }
    .ai-link-btn:hover { background: #f4f4f4; }
    
    /* NEW: Style for the Type chips */
    .chip-row { display: flex; gap: 8px; margin-top: 4px; }
    .chip { 
        padding: 8px 16px; 
        border: 1px solid #ccc; 
        border-radius: 20px; 
        background-color: #f0f0f0; 
        cursor: pointer; 
        transition: background-color 0.2s; 
    }
    .chip:hover { background-color: #e0e0e0; }
    .chip.active { 
        background-color: #007bff; 
        color: white; 
        border-color: #007bff; 
    }
    /* FIX: Corrects the link styling for the dashboard cards */
    .dashboard-card.action-card {
        text-decoration: none;
        color: inherit;
        display: block;
    }
    /* FIX: Styles the list inside the down games modal */
    .game-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid #e0e0e0;
    }
    .game-list-item:last-child {
        border-bottom: none;
    }
    .game-title {
        flex-grow: 1;
        font-weight: 600;
    }
    .game-status-buttons {
        display: flex;
        gap: 8px;
    }
    .status-button {
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid #ccc;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s, color 0.2s;
    }
    .status-button.up {
        background-color: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
    }
    .status-button.down {
        background-color: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
    }
  </style>

  <div class="dashboard-grid">
    <div class="dashboard-card action-card color-orange card-clickable" id="addNewIssueCard" tabindex="0" aria-label="Log a New Issue">
      <div class="card-content-top">
        <div class="card-icon"><i class="fa-solid fa-circle-plus"></i></div>
        <div class="card-text-group">
          <h3>Log a New Issue</h3>
          <p class="card-description">Add a new issue with all details.</p>
        </div>
      </div>
    </div>
    <a href="{{ url_for('pm_tracking_page') }}" class="dashboard-card action-card color-green">
      <div class="card-content-top">
        <div class="card-icon"><i class="fa-solid fa-list-check"></i></div>
        <div class="card-text-group">
          <h3>Log PMs</h3>
          <p class="card-description">Log completed preventative maintenance.</p>
        </div>
      </div>
    </a>

    <div class="dashboard-card action-card color-red card-clickable" id="downGamesCard" tabindex="0" aria-label="Update Down Games">
      <div class="card-content-top">
        <div class="card-icon"><i class="fa-solid fa-gamepad"></i></div>
        <div class="card-text-group">
          <h3>Update Down Games</h3>
        </div>
      </div>

      <div class="down-games-metrics">
        <div class="metric">
          <div class="metric-label">Down</div>
          <div class="metric-value" id="downGamesCount">—</div>
        </div>
        <div class="metric">
          <div class="metric-label">Uptime</div>
          <div class="metric-chip" id="downGamesUptime">--%</div>
        </div>
      </div>
    </div>
  </div>

  <div id="downGamesModal" class="simple-modal" hidden>
    <div class="simple-modal__overlay" data-close></div>
    <div class="simple-modal__panel" role="dialog" aria-modal="true" aria-labelledby="dgm-title">
      <div class="simple-modal__header">
        <h3 id="dgm-title">Update Down Games</h3>
        <button class="simple-modal__close" type="button" aria-label="Close" data-close>&times;</button>
      </div>
      <div class="simple-modal__body" id="dgm-body">
        <div class="game-list">
          </div>
      </div>
    </div>
  </div>

  <div id="addIssueModal" class="simple-modal" hidden>
      <div class="simple-modal__overlay" data-close></div>
      <div class="simple-modal__panel" role="dialog" aria-modal="true" aria-labelledby="ai-title">
          <div class="simple-modal__header">
              <h3 id="ai-title">Log a New Issue</h3>
              <button class="simple-modal__close" type="button" aria-label="Close" data-close>&times;</button>
          </div>
          <div class="simple-modal__body">
              <form id="newIssueForm" novalidate>
                  <input type="hidden" id="categoryInput" name="category" value="gameroom" />
                  <div class="form-grid">

                      <div class="full-width form-group">
                          <label>Type</label>
                          <div class="chip-row" id="issueTypeChips">
                              <button class="chip active" type="button" data-type="game">Game</button>
                              <button class="chip" type="button" data-type="facility">Facility</button>
                              <button class="chip" type="button" data-type="attraction">Attraction</button>
                          </div>
                      </div>

                      <div class="form-group">
                          <label for="problemDescriptionInput">Problem Description *</label>
                          <input id="problemDescriptionInput" name="problemDescription" type="text" required placeholder="Short name (ex: Skee-Ball #3 jam)">
                      </div>

                      <div class="form-group">
                          <label for="equipmentNameInput">Equipment Name</label>
                          <input
                              id="equipmentNameInput"
                              name="equipmentName"
                              type="text"
                              placeholder="Select or type a game name"
                              list="games-list"
                              autocomplete="off"
                              required>
                      </div>

                      <div class="form-group">
                          <label for="priorityInput">Priority</label>
                          <select id="priorityInput" name="priority">
                              <option value="low">low</option>
                              <option value="medium" selected>medium</option>
                              <option value="high">high</option>
                          </select>
                      </div>

                      <div class="form-group">
                          <label for="newStatusInput">Status</label>
                          <select id="newStatusInput" name="status">
                              <option value="open" selected>Open</option>
                              <option value="in_progress">In Progress</option>
                          </select>
                      </div>

                      <div class="form-group">
                          <label for="assignedEmployeeInput">Assigned Employee</label>
                          <select id="assignedEmployeeInput" name="assignedEmployee">
                              <option value="">— Unassigned —</option>
                          </select>
                      </div>

                      <div class="form-group">
                          <label for="targetDateInput">Target Date</label>
                          <input id="targetDateInput" name="targetDate" type="date" placeholder="mm/dd/yyyy" required>
                      </div>

                      <div class="full-width form-group">
                          <label for="notesInput">Notes</label>
                          <textarea id="notesInput" name="notes" rows="3" placeholder="Extra info…"></textarea>
                      </div>
                  </div>

                  <div class="button-row" style="display:flex; justify-content:flex-end; gap:10px;">
                      <button type="submit">Add Issue</button>
                  </div>

                  <datalist id="games-list"></datalist>
              </form>
          </div>
      </div>
  </div>
{% endblock content %}

{% block scripts %}
  {{ super() }}
  <script type="module" src="{{ url_for('static', filename='js/modules/dashboardDownGamesCard.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='js/modules/downGamesQuickUpdate.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='js/modules/dashboardIssuesCard.js') }}"></script>
  {% endblock %}